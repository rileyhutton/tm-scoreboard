<!DOCTYPE html>
<html>
<head>
  <title>WebSocket ECG Monitor â€“ Blue Flash on BPM</title>
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .controls {
      margin-bottom: 20px;
    }
    input {
      width: 300px;
      padding: 8px;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px;
      cursor: pointer;
    }
    #bpm {
      font-size: 24px;
      color: #ff4444;
      margin: 20px 0;
    }
    /* Container for canvases */
    #canvasContainer {
      position: relative;
      width: 1000px;
      height: 400px;
      border: 1px solid #ddd;
      background: #f8f8f8;
    }
    /* The static ECG trace canvas */
    #ecgCanvas {
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
    }
    /* The overlay for the live pointer dot */
    #pointerCanvas {
      position: absolute;
      left: 0;
      top: 0;
      z-index: 2;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <div class="controls">
      <input type="text" id="wsUrl" placeholder="ws://localhost:8080" value="ws://192.168.8.211:81">
      <button onclick="connect()">Connect</button>
    </div>
    <div id="bpm">BPM: --</div>
    <div id="canvasContainer">
      <canvas id="ecgCanvas" width="1000" height="400"></canvas>
      <canvas id="pointerCanvas" width="1000" height="400"></canvas>
    </div>
    <img src="images/ecg_diagram.png" alt="ECG Diagram" width="200px" style="position: relative; left: 50%; transform: translate(-50%, 0px); margin-top: 20px;">
  </div>

  <script>
    // Get both canvases and their 2D contexts.
    const ecgCanvas = document.getElementById('ecgCanvas');
    const ecgCtx = ecgCanvas.getContext('2d');
    const pointerCanvas = document.getElementById('pointerCanvas');
    const pointerCtx = pointerCanvas.getContext('2d');

    // Drawing parameters
    const stepX = 1;                // Pixels to advance for each new sample.
    const clearExtra = 2;           // Extra width (in pixels) to clear to avoid ghosting.
    const scaleY = ecgCanvas.height / 4095;  // Adjust this based on your ECG amplitude.
    const baseline = 0;   // Optional baseline.
    
    // Drawing state
    let currentX = 0;
    let lastY = baseline;
    let ws = null;
    
    // Colors: default line color is red.
    let lineColor = '#FF0000';
    let flashTimeout = null;

    // Set drawing styles for the ECG trace.
    ecgCtx.lineWidth = 4;          // Thicker line.
    ecgCtx.shadowBlur = 10;
    ecgCtx.shadowColor = '#FF0000';

    // Connect to the websocket.
    function connect() {
      if (ws) ws.close();
      const url = document.getElementById('wsUrl').value;
      ws = new WebSocket(url);

      ws.onmessage = (event) => {
        const msg = event.data;
        if (msg.startsWith('ecg:')) {
          const value = parseFloat(msg.split(':')[1]);
          drawECGPoint(value);
        } else if (msg.startsWith('bpm:')) {
          document.getElementById('bpm').textContent = `BPM: ${msg.split(':')[1]}`;
          flashLineBlue();
        }
      };

      ws.onclose = () => {
        console.log('WebSocket closed.');
      };
    }

    // Flash the ECG line blue for a short duration.
    function flashLineBlue() {
      // Change line color to blue and update the shadow color.
      lineColor = '#0000FF';
      ecgCtx.shadowColor = '#0000FF';

      // Clear any previous timeout and revert back after 100ms.
      if (flashTimeout) clearTimeout(flashTimeout);
      flashTimeout = setTimeout(() => {
        lineColor = '#FF0000';
        ecgCtx.shadowColor = '#FF0000';
      }, 100); // Duration of the blue flash in milliseconds.
    }

    // Draw a new ECG point.
    function drawECGPoint(value) {
      // Calculate the new y coordinate.
      const newY = ecgCanvas.height - (value * scaleY);

      // Before drawing, clear the vertical slice where we'll draw the new segment.
      ecgCtx.clearRect(currentX, 0, stepX + clearExtra, ecgCanvas.height);

      // Set stroke style based on the current line color.
      ecgCtx.strokeStyle = lineColor;

      // Draw the line segment from (currentX, lastY) to (currentX + stepX, newY).
      ecgCtx.beginPath();
      ecgCtx.moveTo(currentX, lastY);
      ecgCtx.lineTo(currentX + stepX, newY);
      ecgCtx.stroke();

      // Advance the x coordinate.
      currentX += stepX;
      lastY = newY;

      // When reaching the right edge, clear the column and wrap around.
      if (currentX >= ecgCanvas.width) {
        ecgCtx.clearRect(0, 0, stepX + clearExtra, ecgCanvas.height);
        currentX = 0;
      }

      // Update the pointer.
      drawPointer();
    }

    // Draw a glowing red (or blue) dot at the current drawing position.
    function drawPointer() {
      // Clear the pointer canvas.
      pointerCtx.clearRect(0, 0, pointerCanvas.width, pointerCanvas.height);

      // Set pointer style: a smaller (thinner) dot.
      pointerCtx.beginPath();
      pointerCtx.arc(currentX, lastY, 5, 0, 2 * Math.PI);
      pointerCtx.fillStyle = lineColor;
      pointerCtx.shadowBlur = 10;
      pointerCtx.shadowColor = lineColor;
      pointerCtx.fill();
    }

    // Optional: handle window resize. Note that resizing clears the current ECG trace.
    window.addEventListener('resize', () => {
      const newWidth = window.innerWidth * 0.9;
      const newHeight = window.innerHeight * 0.7;
      ecgCanvas.width = newWidth;
      ecgCanvas.height = newHeight;
      pointerCanvas.width = newWidth;
      pointerCanvas.height = newHeight;

      // Update scaling and reset drawing position.
      currentX = 0;
      lastY = newHeight / 2;
    });

    // Clean up on exit.
    window.addEventListener('beforeunload', () => {
      if (ws) ws.close();
    });
  </script>
</body>
</html>
